# Commit-Preparation Rules

## When to Apply
Apply these instructions **whenever you suggest code changes that are ready to be committed**, or when the user asks to prepare a commit.

---

## SYSTEM-FIRST IMPLEMENTATION RULE

Before editing any files:

### Phase 1 — System Impact Scan (NO CODE)
- Follow the System Impact Scan defined in `claude.md`
- Do not modify files
- Do not suggest commits
- Output only analysis sections

If more than **5 files** appear necessary:
- Stop
- Ask for confirmation before proceeding

---

### Phase 2 — Scoped Implementation
Only after Phase 1 is acknowledged:

- Modify **only the files identified**
- Do NOT rescan the repository
- Do NOT introduce unrelated refactors
- Prefer completeness over minimal diff
- If a missing file is discovered:
  - Stop
  - Report it
  - Do not guess

---

## COST & SCOPE SAFETY

- If total changes exceed ~300 lines, stop and summarize instead
- Avoid broad “search-and-edit” operations unless explicitly requested
- Do not rewrite files for stylistic reasons unless asked

---

## COMPLETENESS CHECK (MANDATORY, NO CODE)

Before stating work is complete, explicitly confirm:

- Feature is reachable from a real entry point
- Runtime configuration enables it
- No dead or orphaned code paths remain
- Tests reflect actual execution paths, not mocks only

Respond with:
✔ Confirmed  
or  
❌ Not confirmed (explain)

---

## Required Output Before Any Commit Suggestion

Before suggesting a commit message or finalizing changes, ALWAYS generate the following sections in Markdown:

---

### 1. Summary of Changes
- Brief, high-level description of what changed
- Focus on behavior, not line-by-line edits

---

### 2. Architectural Impact
- Explicitly state whether this change affects:
  - System architecture
  - Data flow
  - APIs or contracts
  - Performance characteristics
  - Security or compliance
- If **no architectural change**, state: `No architectural changes`

---

### 3. Bug / Issue RCA (if applicable)
If the change fixes a bug or regression, include:
- Root cause
- Why it happened
- Why it was not caught earlier
- Whether similar issues may exist elsewhere

---

### 4. Fix & Design Decisions
Explain:
- Why this solution was chosen
- Alternatives considered (briefly)
- Trade remembered (simplicity, performance, safety, scope)

---

### 5. Reasoning Summary (No Hidden Chain-of-Thought)
Provide a **concise, user-facing reasoning summary** that explains:
- The key insights that led to the solution
- Assumptions made
- Constraints considered

---

### 6. Risk Assessment
- Potential risks introduced by the change
- Rollback considerations
- Areas to monitor after deployment

---

### 7. Suggested Commit Message
Follow this format:

<type>(<scope>): <short summary>

<body - what and why>

<footer - breaking changes, issues closed>
