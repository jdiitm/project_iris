name: CI Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      run_tier1:
        description: 'Run Tier 1 extended tests'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

env:
  OTP_VERSION: '26'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
      
      - name: Cache Erlang build
        uses: actions/cache@v4
        with:
          path: ebin/
          key: ${{ runner.os }}-erlang-${{ hashFiles('src/**/*.erl') }}
      
      - name: Build
        run: make all
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: ebin/

  tier0:
    name: "Tier 0: Required Tests"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: ebin/
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Run Tier 0 Tests
        run: |
          chmod +x tests/run_tests.py
          python3 tests/run_tests.py --tier 0 --ci
        timeout-minutes: 10
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-tier0
          path: tests/artifacts/
          retention-days: 7
      
      - name: Test Summary
        if: always()
        run: |
          echo "## Tier 0 Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -f tests/artifacts/runs/*/summary.json ]; then
            cat tests/artifacts/runs/*/summary.json | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          totals = data.get('totals', {})
          print(f\"| Metric | Value |\")
          print(f\"|--------|-------|\")
          print(f\"| Tests Run | {totals.get('tests_run', 0)} |\")
          print(f\"| Passed | {totals.get('tests_passed', 0)} |\")
          print(f\"| Failed | {totals.get('tests_failed', 0)} |\")
          print(f\"| Duration | {totals.get('duration_seconds', 0):.1f}s |\")
          "
          fi

  tier1:
    name: "Tier 1: Extended Tests"
    runs-on: ubuntu-latest
    needs: tier0
    # Run on schedule, manual trigger with tier1 flag, or nightly
    if: |
      github.event_name == 'schedule' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_tier1 == 'true')
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: ebin/
      
      - name: Install dependencies
        run: pip install pyyaml
      
      - name: Run Tier 1 Tests
        run: |
          chmod +x tests/run_tests.py
          python3 tests/run_tests.py --tier 1 --ci
        timeout-minutes: 30
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-tier1
          path: tests/artifacts/
          retention-days: 14

  correctness-check:
    name: "Message Correctness"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: ebin/
      
      - name: Run Correctness Tests
        run: |
          chmod +x tests/run_tests.py
          python3 tests/run_tests.py --suite integration --ci
        timeout-minutes: 10
      
      - name: Verify No Message Loss
        run: |
          echo "Checking for message loss in test logs..."
          if grep -r "message_lost" tests/artifacts/ 2>/dev/null; then
            echo "::error::Message loss detected in tests!"
            exit 1
          fi
          echo "No message loss detected ✓"
      
      - name: Verify No Duplicates
        run: |
          echo "Checking for message duplicates in test logs..."
          if grep -r "duplicate_detected" tests/artifacts/ 2>/dev/null; then
            echo "::warning::Message duplicates detected in tests"
          fi
          echo "Duplicate check complete ✓"
