# =============================================================================
# Project Iris: Global Cluster Simulation (24-Core / 32GB)
# =============================================================================
# Simulates a 5-region global deployment with:
# - 3 Core regions: US-East (primary), US-West, EU-Frankfurt
# - 2 High-latency edge regions: Sydney, São Paulo
# - Network latency injection via Pumba
# =============================================================================

x-core-defaults: &core-defaults
  image: erlang:25-alpine
  deploy:
    resources:
      limits: {memory: 2G, cpus: '2'}
  volumes:
    - ../../:/app:ro
  working_dir: /app
  environment:
    - IRIS_COOKIE=${IRIS_COOKIE:-iris_secret}
  # NET_ADMIN capability required for iptables partition testing
  cap_add:
    - NET_ADMIN

x-edge-defaults: &edge-defaults
  image: erlang:25-alpine
  deploy:
    resources:
      limits: {memory: 512M, cpus: '0.5'}
  volumes:
    - ../../:/app:ro
  working_dir: /app
  environment:
    - IRIS_COOKIE=${IRIS_COOKIE:-iris_secret}

x-loadgen-defaults: &loadgen-defaults
  image: python:3.11-slim
  deploy:
    resources:
      limits: {memory: 1G, cpus: '2'}
  volumes:
    - ../../:/app:ro
  working_dir: /app

services:
  # ==========================================================================
  # REGION: US-EAST (Primary)
  # ==========================================================================
  core-east-1:
    <<: *core-defaults
    container_name: core-east-1
    hostname: coreeast1
    command: ["sh", "-c", "cd /app && erl -noinput -sname core_east_1@coreeast1 -setcookie $$IRIS_COOKIE -pa ebin -config config/test -mnesia dir '\"/data/mnesia\"' -eval 'application:ensure_all_started(mnesia), iris_core:init_db(), application:ensure_all_started(iris_core).'"]
    volumes:
      - ../../:/app:ro
      - mnesia-east-1:/data/mnesia
    networks:
      iris_east: {ipv4_address: 172.30.0.10}
      iris_backbone: {ipv4_address: 172.29.0.10}
    healthcheck:
      test: ["CMD-SHELL", "epmd -names 2>/dev/null | grep -q core_east_1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  core-east-2:
    <<: *core-defaults
    container_name: core-east-2
    hostname: coreeast2
    # Secondary core: Join primary's Mnesia cluster (wait for primary to be ready)
    command: ["sh", "-c", "cd /app && rm -rf /data/mnesia/* && erl -noinput -sname core_east_2@coreeast2 -setcookie $$IRIS_COOKIE -pa ebin -config config/test -mnesia dir '\"/data/mnesia\"' -eval 'timer:sleep(5000), pong = net_adm:ping(core_east_1@coreeast1), mnesia:start(), mnesia:change_config(extra_db_nodes, [core_east_1@coreeast1]), mnesia:change_table_copy_type(schema, node(), disc_copies), application:ensure_all_started(iris_core).'"]
    volumes:
      - ../../:/app:ro
      - mnesia-east-2:/data/mnesia
    networks:
      iris_east: {ipv4_address: 172.30.0.11}
      iris_backbone: {ipv4_address: 172.29.0.11}
    healthcheck:
      test: ["CMD-SHELL", "epmd -names 2>/dev/null | grep -q core_east_2"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s
    depends_on:
      core-east-1: {condition: service_healthy}

  edge-east-1:
    <<: *edge-defaults
    container_name: edge-east-1
    hostname: edgeeast1
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_east_1@edgeeast1 -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8085 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_east_1@coreeast1).'"]
    ports: ["8085:8085"]
    networks:
      iris_east: {ipv4_address: 172.30.0.20}
      iris_backbone: {ipv4_address: 172.29.0.20}
    depends_on:
      core-east-1: {condition: service_healthy}

  edge-east-2:
    <<: *edge-defaults
    container_name: edge-east-2
    hostname: edgeeast2
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_east_2@edgeeast2 -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8086 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_east_2@coreeast2).'"]
    ports: ["8086:8086"]
    networks:
      iris_east: {ipv4_address: 172.30.0.21}
      iris_backbone: {ipv4_address: 172.29.0.21}
    depends_on:
      core-east-2: {condition: service_started}

  # ==========================================================================
  # REGION: US-WEST
  # ==========================================================================
  core-west-1:
    <<: *core-defaults
    container_name: core-west-1
    hostname: corewest1
    # Secondary core: Join primary's Mnesia cluster (wait for primary to be ready)
    command: ["sh", "-c", "cd /app && rm -rf /data/mnesia/* && erl -noinput -sname core_west_1@corewest1 -setcookie $$IRIS_COOKIE -pa ebin -config config/test -mnesia dir '\"/data/mnesia\"' -eval 'timer:sleep(5000), pong = net_adm:ping(core_east_1@coreeast1), mnesia:start(), mnesia:change_config(extra_db_nodes, [core_east_1@coreeast1]), mnesia:change_table_copy_type(schema, node(), disc_copies), application:ensure_all_started(iris_core).'"]
    volumes:
      - ../../:/app:ro
      - mnesia-west-1:/data/mnesia
    networks:
      iris_west: {ipv4_address: 172.31.0.10}
      iris_backbone: {ipv4_address: 172.29.0.30}
    healthcheck:
      test: ["CMD-SHELL", "epmd -names 2>/dev/null | grep -q core_west_1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s
    depends_on:
      core-east-1: {condition: service_healthy}

  core-west-2:
    <<: *core-defaults
    container_name: core-west-2
    hostname: corewest2
    # Secondary core: Join via core-west-1 (wait for parent to be ready)
    command: ["sh", "-c", "cd /app && rm -rf /data/mnesia/* && erl -noinput -sname core_west_2@corewest2 -setcookie $$IRIS_COOKIE -pa ebin -config config/test -mnesia dir '\"/data/mnesia\"' -eval 'timer:sleep(8000), pong = net_adm:ping(core_west_1@corewest1), mnesia:start(), mnesia:change_config(extra_db_nodes, [core_west_1@corewest1]), mnesia:change_table_copy_type(schema, node(), disc_copies), application:ensure_all_started(iris_core).'"]
    volumes:
      - ../../:/app:ro
      - mnesia-west-2:/data/mnesia
    networks:
      iris_west: {ipv4_address: 172.31.0.11}
      iris_backbone: {ipv4_address: 172.29.0.31}
    healthcheck:
      test: ["CMD-SHELL", "epmd -names 2>/dev/null | grep -q core_west_2"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s
    depends_on:
      core-west-1: {condition: service_healthy}

  edge-west-1:
    <<: *edge-defaults
    container_name: edge-west-1
    hostname: edgewest1
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_west_1@edgewest1 -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8087 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_west_1@corewest1).'"]
    ports: ["8087:8087"]
    networks:
      iris_west: {ipv4_address: 172.31.0.20}
      iris_backbone: {ipv4_address: 172.29.0.40}
    depends_on:
      core-west-1: {condition: service_started}

  edge-west-2:
    <<: *edge-defaults
    container_name: edge-west-2
    hostname: edgewest2
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_west_2@edgewest2 -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8088 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_west_2@corewest2).'"]
    ports: ["8088:8088"]
    networks:
      iris_west: {ipv4_address: 172.31.0.21}
      iris_backbone: {ipv4_address: 172.29.0.41}
    depends_on:
      core-west-2: {condition: service_started}

  # ==========================================================================
  # REGION: EU-FRANKFURT
  # ==========================================================================
  core-eu-1:
    <<: *core-defaults
    container_name: core-eu-1
    hostname: coreeu1
    # Secondary core: Join primary's Mnesia cluster (wait for primary to be ready)
    command: ["sh", "-c", "cd /app && rm -rf /data/mnesia/* && erl -noinput -sname core_eu_1@coreeu1 -setcookie $$IRIS_COOKIE -pa ebin -config config/test -mnesia dir '\"/data/mnesia\"' -eval 'timer:sleep(5000), pong = net_adm:ping(core_east_1@coreeast1), mnesia:start(), mnesia:change_config(extra_db_nodes, [core_east_1@coreeast1]), mnesia:change_table_copy_type(schema, node(), disc_copies), application:ensure_all_started(iris_core).'"]
    volumes:
      - ../../:/app:ro
      - mnesia-eu-1:/data/mnesia
    networks:
      iris_eu: {ipv4_address: 172.33.0.10}
      iris_backbone: {ipv4_address: 172.29.0.50}
    healthcheck:
      test: ["CMD-SHELL", "epmd -names 2>/dev/null | grep -q core_eu_1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s
    depends_on:
      core-east-1: {condition: service_healthy}

  core-eu-2:
    <<: *core-defaults
    container_name: core-eu-2
    hostname: coreeu2
    # Secondary core: Join via core-eu-1 (wait for parent to be ready)
    command: ["sh", "-c", "cd /app && rm -rf /data/mnesia/* && erl -noinput -sname core_eu_2@coreeu2 -setcookie $$IRIS_COOKIE -pa ebin -config config/test -mnesia dir '\"/data/mnesia\"' -eval 'timer:sleep(8000), pong = net_adm:ping(core_eu_1@coreeu1), mnesia:start(), mnesia:change_config(extra_db_nodes, [core_eu_1@coreeu1]), mnesia:change_table_copy_type(schema, node(), disc_copies), application:ensure_all_started(iris_core).'"]
    healthcheck:
      test: ["CMD-SHELL", "epmd -names 2>/dev/null | grep -q core_eu_2"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s
    volumes:
      - ../../:/app:ro
      - mnesia-eu-2:/data/mnesia
    networks:
      iris_eu: {ipv4_address: 172.33.0.11}
      iris_backbone: {ipv4_address: 172.29.0.51}
    depends_on:
      core-eu-1: {condition: service_started}

  edge-eu-1:
    <<: *edge-defaults
    container_name: edge-eu-1
    hostname: edgeeu1
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_eu_1@edgeeu1 -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8089 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_eu_1@coreeu1).'"]
    ports: ["8089:8089"]
    networks:
      iris_eu: {ipv4_address: 172.33.0.20}
      iris_backbone: {ipv4_address: 172.29.0.60}
    depends_on:
      core-eu-1: {condition: service_started}

  edge-eu-2:
    <<: *edge-defaults
    container_name: edge-eu-2
    hostname: edgeeu2
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_eu_2@edgeeu2 -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8094 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_eu_2@coreeu2).'"]
    ports: ["8094:8094"]
    networks:
      iris_eu: {ipv4_address: 172.33.0.21}
      iris_backbone: {ipv4_address: 172.29.0.61}
    depends_on:
      core-eu-2: {condition: service_started}

  # ==========================================================================
  # REGION: SYDNEY (High-Latency Edge - 100ms to US-East)
  # ==========================================================================
  edge-sydney-1:
    <<: *edge-defaults
    container_name: edge-sydney-1
    hostname: edgesydney1
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_sydney_1@edgesydney1 -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8090 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_east_1@coreeast1).'"]
    ports: ["8090:8090"]
    networks:
      iris_sydney: {ipv4_address: 172.32.0.20}
      iris_backbone: {ipv4_address: 172.29.0.70}
    depends_on:
      core-east-1: {condition: service_healthy}

  edge-sydney-2:
    <<: *edge-defaults
    container_name: edge-sydney-2
    hostname: edgesydney2
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_sydney_2@edgesydney2 -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8091 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_east_2@coreeast2).'"]
    ports: ["8091:8091"]
    networks:
      iris_sydney: {ipv4_address: 172.32.0.21}
      iris_backbone: {ipv4_address: 172.29.0.71}
    depends_on:
      core-east-2: {condition: service_started}

  # ==========================================================================
  # REGION: SÃO PAULO (High-Latency Edge - 100ms to US-West)
  # ==========================================================================
  edge-saopaulo:
    <<: *edge-defaults
    container_name: edge-saopaulo
    hostname: edgesaopaulo
    command: ["sh", "-c", "cd /app && erl -noinput -sname edge_saopaulo@edgesaopaulo -hidden -setcookie $$IRIS_COOKIE -pa ebin -config config/test -iris_edge port 8092 -eval 'application:ensure_all_started(iris_edge), net_adm:ping(core_west_1@corewest1).'"]
    ports: ["8092:8092"]
    networks:
      iris_saopaulo: {ipv4_address: 172.34.0.20}
      iris_backbone: {ipv4_address: 172.29.0.80}
    depends_on:
      core-west-1: {condition: service_started}

  # ==========================================================================
  # LOAD GENERATORS
  # ==========================================================================
  loadgen-east:
    <<: *loadgen-defaults
    container_name: loadgen-east
    hostname: loadgen-east
    command: ["python3", "-c", "import time; time.sleep(86400)"]
    networks:
      iris_east: {ipv4_address: 172.30.0.100}
      iris_backbone: {ipv4_address: 172.29.0.100}

  loadgen-west:
    <<: *loadgen-defaults
    container_name: loadgen-west
    hostname: loadgen-west
    command: ["python3", "-c", "import time; time.sleep(86400)"]
    networks:
      iris_west: {ipv4_address: 172.31.0.100}
      iris_backbone: {ipv4_address: 172.29.0.101}

  # ==========================================================================
  # CHAOS INJECTION (Pumba)
  # ==========================================================================
  pumba-sydney:
    image: gaiaadm/pumba
    container_name: pumba-sydney
    profiles: ["chaos"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: netem --duration 8h --delay 100ms:10ms edge-sydney-1 edge-sydney-2

  pumba-saopaulo:
    image: gaiaadm/pumba
    container_name: pumba-saopaulo
    profiles: ["chaos"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: netem --duration 8h --delay 100ms:10ms edge-saopaulo

  # ==========================================================================
  # PARTITION CHAOS (Network Partitions)
  # ==========================================================================
  # Use: docker compose --profile chaos-partition up pumba-partition-west
  
  # Partition West region from backbone (creates minority partition)
  pumba-partition-west:
    image: gaiaadm/pumba
    container_name: pumba-partition-west
    profiles: ["chaos-partition"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # 100% packet loss for 30 seconds
    command: netem --duration 30s loss --percent 100 core-west-1 core-west-2

  # Partition EU region from backbone (cross-region chaos)
  pumba-partition-eu:
    image: gaiaadm/pumba
    container_name: pumba-partition-eu
    profiles: ["chaos-partition"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: netem --duration 30s loss --percent 100 core-eu-1 core-eu-2

  # Flapping backbone (intermittent connectivity)
  pumba-backbone-flap:
    image: gaiaadm/pumba
    container_name: pumba-backbone-flap
    profiles: ["chaos-flap"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # 50% packet loss to simulate flapping link
    command: netem --duration 60s loss --percent 50 --correlation 25 core-east-1 core-west-1 core-eu-1

networks:
  iris_east:
    driver: bridge
    ipam: {config: [{subnet: 172.30.0.0/16}]}
  iris_west:
    driver: bridge
    ipam: {config: [{subnet: 172.31.0.0/16}]}
  iris_sydney:
    driver: bridge
    ipam: {config: [{subnet: 172.32.0.0/16}]}
  iris_eu:
    driver: bridge
    ipam: {config: [{subnet: 172.33.0.0/16}]}
  iris_saopaulo:
    driver: bridge
    ipam: {config: [{subnet: 172.34.0.0/16}]}
  iris_backbone:
    driver: bridge
    ipam: {config: [{subnet: 172.29.0.0/16}]}

volumes:
  mnesia-east-1:
  mnesia-east-2:
  mnesia-west-1:
  mnesia-west-2:
  mnesia-eu-1:
  mnesia-eu-2:
