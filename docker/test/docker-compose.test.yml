# =============================================================================
# Project Iris - Deterministic Test Cluster
# =============================================================================
# Full test environment with:
# - Test runner container
# - Core nodes (US-East, US-West)
# - Edge nodes (multiple regions)
# - Isolated network
#
# Usage:
#   docker-compose -f docker/test/docker-compose.test.yml up --build --abort-on-container-exit
#   TEST_SEED=12345 docker-compose -f docker/test/docker-compose.test.yml up --build
# =============================================================================

x-common-env: &common-env
  IRIS_COOKIE: iris_secret
  TEST_SEED: ${TEST_SEED:-42}
  TEST_RUN_ID: ${TEST_RUN_ID:-docker_run}
  PYTHONUNBUFFERED: "1"
  CI: "true"

x-erlang-base: &erlang-base
  image: erlang:25-alpine
  environment:
    <<: *common-env
  volumes:
    - ../../:/app:ro
  working_dir: /app
  networks:
    - test-network

services:
  # ===========================================================================
  # Test Runner
  # ===========================================================================
  test-runner:
    build:
      context: ../..
      dockerfile: docker/test/Dockerfile
    container_name: iris-test-runner
    environment:
      <<: *common-env
      # Connection info for cluster
      EDGE_EAST_HOST: edge-east
      EDGE_EAST_PORT: "8085"
      EDGE_WEST_HOST: edge-west
      EDGE_WEST_PORT: "8087"
      EDGE_SYDNEY_HOST: edge-sydney
      EDGE_SYDNEY_PORT: "8090"
    depends_on:
      core-east:
        condition: service_healthy
      edge-east:
        condition: service_started
    networks:
      - test-network
    # Command can be overridden for specific test suites
    command: ["python3", "-u", "tests/run_tests.py", "--all"]

  # ===========================================================================
  # Core Nodes
  # ===========================================================================
  core-east:
    <<: *erlang-base
    container_name: core-east
    hostname: coreeast
    command: >
      sh -c "cd /app && erl -noinput -sname core_east@coreeast 
        -setcookie $$IRIS_COOKIE -pa ebin -config config/test 
        -mnesia dir '\"/data/mnesia\"'
        -eval 'application:ensure_all_started(mnesia), 
               iris_core:init_db(), 
               application:ensure_all_started(iris_core).'"
    volumes:
      - ../../:/app:ro
      - mnesia-east:/data/mnesia
    healthcheck:
      test: ["CMD-SHELL", "epmd -names 2>/dev/null | grep -q core_east"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'

  core-west:
    <<: *erlang-base
    container_name: core-west
    hostname: corewest
    command: >
      sh -c "cd /app && rm -rf /data/mnesia/* && erl -noinput -sname core_west@corewest 
        -setcookie $$IRIS_COOKIE -pa ebin -config config/test 
        -mnesia dir '\"/data/mnesia\"'
        -eval 'pong = net_adm:ping(core_east@coreeast), 
               timer:sleep(2000),
               mnesia:start(), 
               mnesia:change_config(extra_db_nodes, [core_east@coreeast]),
               application:ensure_all_started(iris_core).'"
    volumes:
      - ../../:/app:ro
      - mnesia-west:/data/mnesia
    depends_on:
      core-east:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'

  # ===========================================================================
  # Edge Nodes
  # ===========================================================================
  edge-east:
    <<: *erlang-base
    container_name: edge-east
    hostname: edgeeast
    command: >
      sh -c "cd /app && erl -noinput -sname edge_east@edgeeast -hidden 
        -setcookie $$IRIS_COOKIE -pa ebin -config config/test 
        -iris_edge port 8085 
        -eval 'application:ensure_all_started(iris_edge), 
               net_adm:ping(core_east@coreeast).'"
    ports:
      - "8085:8085"
    depends_on:
      core-east:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  edge-west:
    <<: *erlang-base
    container_name: edge-west
    hostname: edgewest
    command: >
      sh -c "cd /app && erl -noinput -sname edge_west@edgewest -hidden 
        -setcookie $$IRIS_COOKIE -pa ebin -config config/test 
        -iris_edge port 8087 
        -eval 'application:ensure_all_started(iris_edge), 
               net_adm:ping(core_west@corewest).'"
    ports:
      - "8087:8087"
    depends_on:
      core-west:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  edge-sydney:
    <<: *erlang-base
    container_name: edge-sydney
    hostname: edgesydney
    command: >
      sh -c "cd /app && erl -noinput -sname edge_sydney@edgesydney -hidden 
        -setcookie $$IRIS_COOKIE -pa ebin -config config/test 
        -iris_edge port 8090 
        -eval 'application:ensure_all_started(iris_edge), 
               net_adm:ping(core_east@coreeast).'"
    ports:
      - "8090:8090"
    depends_on:
      core-east:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

networks:
  test-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.40.0.0/24

volumes:
  mnesia-east:
  mnesia-west:
